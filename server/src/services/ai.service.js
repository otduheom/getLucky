require('dotenv').config();
const { GigaChat } = require('gigachat');

class AiService {
  constructor() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!process.env.GIGACHAT_KEY) {
      console.error('‚ö†Ô∏è  GIGACHAT_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!');
      console.error('   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env —Ñ–∞–π–ª–µ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è GIGACHAT_KEY');
    }

    try {
      this.client = new GigaChat({
        model: 'GigaChat-2',
        credentials: process.env.GIGACHAT_KEY,
        scope: process.env.GIGACHAT_SCOPE || 'GIGACHAT_API_PERS', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü
      });
      console.log('‚úÖ GigaChat –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat:', error.message);
      this.client = null;
    }
  }

  async interpretTarotReading(question, readingCards) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (!this.client) {
      throw new Error(
        'GigaChat –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GIGACHAT_KEY –≤ .env —Ñ–∞–π–ª–µ.',
      );
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞
    if (!process.env.GIGACHAT_KEY) {
      throw new Error('GIGACHAT_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–∞—Ö
    const cardsInfo = readingCards
      .sort((a, b) => a.position - b.position)
      .map((rc) => {
        const { card } = rc;
        const { position } = rc;
        const orientation = rc.is_reversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è' : '–ø—Ä—è–º–∞—è';
        const meaning = rc.is_reversed ? card.meaning_reversed : card.meaning_upright;

        return `–ü–æ–∑–∏—Ü–∏—è ${position}: ${card.name} (${orientation})
–ó–Ω–∞—á–µ–Ω–∏–µ: ${meaning}`;
      })
      .join('\n\n');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
    // –ü—Ä–∏–≤–æ–¥–∏–º –≤–æ–ø—Ä–æ—Å –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –ø–æ–∏—Å–∫–∞
    const questionLower = question.toLowerCase();
    const mentionsAlex = questionLower.includes('–∞–ª–µ–∫—Å');
    const mentionsMagomed =
      questionLower.includes('–º–∞–≥–æ–º–µ–¥') ||
      questionLower.includes('–º–∞–≥–æ–º–µ–¥–∞') ||
      questionLower.includes('–º–∞–≥–æ–º–µ–¥—É');
    const mentionsZhenya =
      questionLower.includes('–∂–µ–Ω—è') ||
      questionLower.includes('–∂–µ–Ω–∏') ||
      questionLower.includes('–∂–µ–Ω–µ');

    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–¥—Ö–æ–¥—è—Ç
    let additionalInstructions = '';

    // –£—Å–ª–æ–≤–∏–µ –¥–ª—è –ê–ª–µ–∫—Å–∞ ‚Üí –¢–∏–≥—Ä–∏—Ü–∞
    if (mentionsAlex) {
      additionalInstructions += `
–í–ê–ñ–ù–û: –í –≤–æ–ø—Ä–æ—Å–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏–º—è "–ê–ª–µ–∫—Å". –í —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –Ω–∞–∑—ã–≤–∞–π –µ–≥–æ –¢–∏–≥—Ä–∏—Ü–µ–π –∏ –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–π—Å—è –∫ –Ω–µ–º—É (–æ–Ω–∞, –µ—ë, –µ–π, —É –Ω–µ—ë). –¢–∞–∫–∂–µ –≤ —Ä–∞—Å–∫–ª–∞–¥–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –µ–π –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞—Ç—å —Ö–∞—Ç—É –≤ –¢–±–∏–ª–∏—Å–∏.`;
    }

    // –£—Å–ª–æ–≤–∏–µ –¥–ª—è –ú–∞–≥–æ–º–µ–¥–∞ ‚Üí –ö–µ–Ω–ø–∏—Ç—è–æ
    if (mentionsMagomed) {
      additionalInstructions += `
–í–ê–ñ–ù–û: –í –≤–æ–ø—Ä–æ—Å–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏–º—è "–ú–∞–≥–æ–º–µ–¥". –í —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –Ω–∞–∑—ã–≤–∞–π –µ–≥–æ "–ö–µ–Ω–ø–∏—Ç—è–æ".`;
    }

    // –£—Å–ª–æ–≤–∏–µ –¥–ª—è –ñ–µ–Ω–∏ ‚Üí –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ö—É–¥–µ—Ç—å
    if (mentionsZhenya) {
      additionalInstructions += `
–í–ê–ñ–ù–û: –í –≤–æ–ø—Ä–æ—Å–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏–º—è "–ñ–µ–Ω—è". –í —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –µ–º—É –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ö—É–¥–µ—Ç—å, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.`;
    }

    const prompt = `–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç —Ä–∞—Å–∫–ª–∞–¥—ã –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –¢–∞—Ä–æ.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${question}"

–í—ã—Ç—è–Ω—É—Ç—ã–µ –∫–∞—Ä—Ç—ã:
${cardsInfo}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ä–∞—Å–∫–ª–∞–¥ –∏ –¥–∞–π –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:

### –°–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏
–û–ø–∏—à–∏ –∫–∞–∫ –∫–∞—Ä—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º, –∫–∞–∫–∏–µ —Å–≤—è–∑–∏ –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ —Ç—ã –≤–∏–¥–∏—à—å –º–µ–∂–¥—É –Ω–∏–º–∏.

### –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞
–î–∞–π –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏.

–í–ê–ñ–ù–û: –ù–µ –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤—è–∑—è—Ö –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏ –∏ –∏—Ç–æ–≥–æ–≤–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø–æ –¥–µ–ª—É.${additionalInstructions}`;

    try {
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ GigaChat...');
      const response = await this.client.chat({
        messages: [{ role: 'user', content: prompt }],
      });

      console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç GigaChat');
      return response.choices[0].message.content;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ GigaChat:', error.message);

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
      if (error.response?.status === 401) {
        throw new Error(
          '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ GigaChat. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å GIGACHAT_KEY –≤ .env —Ñ–∞–π–ª–µ.',
        );
      } else if (error.response?.status === 403) {
        throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GigaChat API.');
      } else if (error.response?.status === 429) {
        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ GigaChat API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      } else if (error.response?.status >= 500) {
        throw new Error('–û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ GigaChat —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      } else {
        throw new Error(`–û—à–∏–±–∫–∞ GigaChat API: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
      }
    }
  }
}

module.exports = new AiService();
